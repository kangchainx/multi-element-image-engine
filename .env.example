# MEIE（多元素图像引擎）环境变量示例文件
#
# 使用方法：
# - 将你需要的配置复制到真实环境文件中（不要提交任何密钥/敏感信息）。
# - 下列变量适用于 apps/meie-server（API + worker）。
#
# 说明：
# - 注释包含：用途、示例值和推荐值。
# - 代码中有默认值，但部署时建议显式设置。

# =========================
# 核心依赖
# =========================

# COMFYUI_API_BASE
# 用途：worker 通过该 ComfyUI HTTP 基础地址提交 prompt，并拉取 history/view。
# 示例：http://127.0.0.1:8000
# 推荐：http://127.0.0.1:8000（ComfyUI 与 API/worker 在同一台机器时）
COMFYUI_API_BASE=http://127.0.0.1:8000

# REDIS_URL
# 用途：BullMQ（队列）以及按用户限制“进行中任务数”所使用的 Redis 连接串。
# 示例：redis://127.0.0.1:6379
# 推荐：redis://127.0.0.1:6379（与 API/worker/ComfyUI 同机），或你的托管 Redis 地址
REDIS_URL=redis://127.0.0.1:6379

# QUEUE_NAME
# 用途：BullMQ 队列名（API 入队，worker 消费，API 订阅 QueueEvents）。
# 示例：meie_jobs
# 推荐：meie_jobs
QUEUE_NAME=meie_jobs

# =========================
# ComfyUI 文件路径
# =========================

# COMFY_INPUT_DIR
# 用途：ComfyUI 的 input 目录绝对路径。API 会把上传文件保存到该目录下的 UPLOAD_SUBDIR/<jobId>/...。
# 示例（macOS）：/Users/chris/Documents/ComfyUI/input
# 示例（Windows）：D:/develop/ComfyUI_Files/input
# 推荐：部署时请显式设置（避免依赖包含用户名的默认路径）
COMFY_INPUT_DIR=/absolute/path/to/ComfyUI/input

# COMFY_ROOT（可替代 COMFY_INPUT_DIR）
# 用途：ComfyUI 根目录的绝对路径；input 目录会被解析为 COMFY_ROOT/input。
# 示例（macOS）：/Users/chris/Documents/ComfyUI
# 推荐：为清晰起见优先使用 COMFY_INPUT_DIR；只有在你管理整个 ComfyUI 目录时才设置 COMFY_ROOT。
# COMFY_ROOT=/absolute/path/to/ComfyUI

# UPLOAD_SUBDIR
# 用途：位于 COMFY_INPUT_DIR 内的子目录，用于存放每个任务上传的素材。
# 示例：meie_uploads
# 推荐：meie_uploads
UPLOAD_SUBDIR=meie_uploads

# OUTPUT_DIR_PREFIX
# 用途：ComfyUI workflow 用来归类输出文件的前缀（取决于 workflow 的实现）。
# 示例：MEIE_RUNS
# 推荐：MEIE_RUNS
OUTPUT_DIR_PREFIX=MEIE_RUNS

# =========================
# API 服务配置
# =========================

# HOST
# 用途：API 服务绑定的 host。
# 示例：127.0.0.1
# 推荐：本地开发用 127.0.0.1；容器/虚拟机里并置于反向代理后面时用 0.0.0.0
HOST=127.0.0.1

# PORT
# 用途：API 服务端口。
# 示例：8090
# 推荐：8090
PORT=8090

# CORS_ORIGIN
# 用途：Access-Control-Allow-Origin 的值。
# 示例：http://localhost:5173
# 推荐：生产环境设置为你的前端域名；本地开发可用 '*'
CORS_ORIGIN=*

# MAX_UPLOAD_BYTES
# 用途：POST /v1/jobs 接受的 multipart 总大小上限。
# 示例：52428800
# 推荐：演示环境 52428800（50MB）；如果允许更多大图可增大
MAX_UPLOAD_BYTES=52428800

# MAX_FILES
# 用途：POST /v1/jobs 允许上传的文件数量上限（1 张 ref + N 张 source）。
# 示例：10
# 推荐：10
MAX_FILES=10

# =========================
# 任务超时（Worker）
# =========================

# JOB_TIMEOUT_SECONDS
# 用途：单个任务端到端的硬超时（超过后 worker 会判定任务失败）。
# 示例：7200
# 推荐：慢设备跑 SDXL 可用 7200（2 小时）；演示流水线可适当调低
JOB_TIMEOUT_SECONDS=7200

# NO_PROGRESS_TIMEOUT_SECONDS
# 用途：若连续这么多秒没有观察到 WS 进度，则判定任务失败。
# 示例：900
# 推荐：900（15 分钟）；如果希望卡住更快失败可调低
NO_PROGRESS_TIMEOUT_SECONDS=900

# =========================
# SQLite 持久化
# =========================

# MEIE_DB_PATH
# 用途：SQLite 数据库文件路径，用于持久化任务元数据和结果。
# 示例（仓库相对路径默认值）：apps/meie-server/data/meie.sqlite
# 推荐：服务器上使用挂载到持久化卷的绝对路径
MEIE_DB_PATH=/absolute/path/to/meie.sqlite

# =========================
# Worker 并发/伸缩（BullMQ）
# =========================

# JOBS_PER_DEVICE
# 用途：以 GPU 为优先的并发倍率上限：total_concurrency_default = devices * JOBS_PER_DEVICE。
# 示例：1
# 推荐：1（安全）。仅当你确认 ComfyUI 能并行处理多个任务时再增加
JOBS_PER_DEVICE=1

# WORKER_MAX_PROCESSES
# 用途：硬上限，防止 fork 出过多 worker 进程。
# 示例：8
# 推荐：8
WORKER_MAX_PROCESSES=8

# WORKER_TOTAL_CONCURRENCY
# 用途：覆盖自动计算的总并发（默认会根据 CPU + ComfyUI devices 计算）。
# 示例：2
# 推荐：本地可不设置走自动；生产环境如需更可预测的行为再设置
# WORKER_TOTAL_CONCURRENCY=2

# WORKER_PROCESSES
# 用途：覆盖 worker 进程数（cluster forks）。默认由总并发推导。
# 示例：2
# 推荐：本地可不设置走自动；如需匹配 CPU/GPU 约束再设置
# WORKER_PROCESSES=2

# WORKER_CONCURRENCY_PER_PROCESS
# 用途：每个 worker 进程的 BullMQ 并发。通常保持 1，通过增加 processes 来扩容。
# 示例：1
# 推荐：1
WORKER_CONCURRENCY_PER_PROCESS=1

# =========================
# 请求要求（非环境变量）
# =========================

# X-User-Id（HTTP 请求头）
# 用途：POST /v1/jobs 必需的请求头。用于按用户限制“进行中任务数”（最多 3）。
# 示例：demo-user-123
# 推荐：来自你的鉴权系统的稳定用户标识（不要用 IP）
