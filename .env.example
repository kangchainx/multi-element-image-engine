# MEIE (Multi-Element Image Engine) example environment file
#
# How to use:
# - Copy values you need into your real environment (do NOT commit secrets).
# - Variables below apply to apps/meie-server (API + worker).
#
# Notes:
# - Comments include: purpose, example value, and recommended value.
# - Defaults exist in code, but for deployment you should set these explicitly.

# =========================
# Core Dependencies
# =========================

# COMFYUI_API_BASE
# Purpose: ComfyUI HTTP base URL used by the worker to submit prompts and fetch history/view.
# Example: http://127.0.0.1:8000
# Recommended: http://127.0.0.1:8000 (if ComfyUI runs on same machine as API/worker)
COMFYUI_API_BASE=http://127.0.0.1:8000

# REDIS_URL
# Purpose: Redis connection string used by BullMQ (queue) and user inflight limiting.
# Example: redis://127.0.0.1:6379
# Recommended: redis://127.0.0.1:6379 (same machine as API/worker/ComfyUI), or your managed Redis URL
REDIS_URL=redis://127.0.0.1:6379

# QUEUE_NAME
# Purpose: BullMQ queue name (API enqueues, workers consume, API subscribes to QueueEvents).
# Example: meie:jobs
# Recommended: meie:jobs
QUEUE_NAME=meie:jobs

# =========================
# ComfyUI Filesystem Paths
# =========================

# COMFY_INPUT_DIR
# Purpose: Absolute path to ComfyUI input directory. API saves uploads here under UPLOAD_SUBDIR/<jobId>/...
# Example (macOS): /Users/chris/Documents/ComfyUI/input
# Recommended: Set explicitly in deployment (avoid relying on username-based defaults)
COMFY_INPUT_DIR=/absolute/path/to/ComfyUI/input

# COMFY_ROOT (alternative to COMFY_INPUT_DIR)
# Purpose: Absolute path to ComfyUI root directory; input dir will be resolved as COMFY_ROOT/input.
# Example (macOS): /Users/chris/Documents/ComfyUI
# Recommended: Prefer COMFY_INPUT_DIR for clarity; set COMFY_ROOT only if you manage the whole ComfyUI dir.
# COMFY_ROOT=/absolute/path/to/ComfyUI

# UPLOAD_SUBDIR
# Purpose: Subdirectory inside COMFY_INPUT_DIR where uploaded job assets are stored.
# Example: meie_uploads
# Recommended: meie_uploads
UPLOAD_SUBDIR=meie_uploads

# OUTPUT_DIR_PREFIX
# Purpose: Prefix used by the ComfyUI workflow to group output files (depends on workflow implementation).
# Example: MEIE_RUNS
# Recommended: MEIE_RUNS
OUTPUT_DIR_PREFIX=MEIE_RUNS

# =========================
# API Server Settings
# =========================

# HOST
# Purpose: API server bind host.
# Example: 127.0.0.1
# Recommended: 127.0.0.1 for local dev; 0.0.0.0 when running behind a reverse proxy in containers/VMs
HOST=127.0.0.1

# PORT
# Purpose: API server port.
# Example: 8787
# Recommended: 8787
PORT=8787

# CORS_ORIGIN
# Purpose: Access-Control-Allow-Origin value.
# Example: http://localhost:5173
# Recommended: Set to your frontend origin in production; '*' is okay for local dev.
CORS_ORIGIN=*

# MAX_UPLOAD_BYTES
# Purpose: Maximum total multipart size accepted by POST /v1/jobs.
# Example: 52428800
# Recommended: 52428800 (50MB) for demo; increase if you accept many large images.
MAX_UPLOAD_BYTES=52428800

# MAX_FILES
# Purpose: Maximum number of uploaded files in POST /v1/jobs (1 ref + N sources).
# Example: 10
# Recommended: 10
MAX_FILES=10

# =========================
# Job Timeouts (Worker)
# =========================

# JOB_TIMEOUT_SECONDS
# Purpose: Hard timeout for a job end-to-end (worker fails job after this).
# Example: 7200
# Recommended: 7200 (2 hours) for SDXL on slow devices; lower for demo pipelines.
JOB_TIMEOUT_SECONDS=7200

# NO_PROGRESS_TIMEOUT_SECONDS
# Purpose: Fail a job if no WS progress is observed for this many seconds.
# Example: 900
# Recommended: 900 (15 minutes); lower if you want faster failure on hangs.
NO_PROGRESS_TIMEOUT_SECONDS=900

# =========================
# SQLite Persistence
# =========================

# MEIE_DB_PATH
# Purpose: Path to SQLite DB file used for job metadata/results persistence.
# Example (repo-relative default): apps/meie-server/data/meie.sqlite
# Recommended: Use an absolute path on servers, on a persistent volume.
MEIE_DB_PATH=/absolute/path/to/meie.sqlite

# =========================
# Worker Scaling (BullMQ)
# =========================

# JOBS_PER_DEVICE
# Purpose: GPU-first concurrency cap multiplier: total_concurrency_default = devices * JOBS_PER_DEVICE.
# Example: 1
# Recommended: 1 (safe). Increase only if you know ComfyUI can handle parallel jobs.
JOBS_PER_DEVICE=1

# WORKER_MAX_PROCESSES
# Purpose: Hard cap to prevent forking too many worker processes.
# Example: 8
# Recommended: 8
WORKER_MAX_PROCESSES=8

# WORKER_TOTAL_CONCURRENCY
# Purpose: Override computed total concurrency (otherwise computed from CPU + ComfyUI devices).
# Example: 2
# Recommended: Leave unset for auto; set when you want predictable behavior in production.
# WORKER_TOTAL_CONCURRENCY=2

# WORKER_PROCESSES
# Purpose: Override number of worker processes (cluster forks). Default derived from total concurrency.
# Example: 2
# Recommended: Leave unset for auto; set to match CPU/gpu constraints.
# WORKER_PROCESSES=2

# WORKER_CONCURRENCY_PER_PROCESS
# Purpose: BullMQ concurrency per worker process. Usually keep 1 and scale by processes.
# Example: 1
# Recommended: 1
WORKER_CONCURRENCY_PER_PROCESS=1

# =========================
# Request Requirements (not env vars)
# =========================

# X-User-Id (HTTP header)
# Purpose: Required header on POST /v1/jobs. Used for per-user inflight limiting (max 3).
# Example: demo-user-123
# Recommended: A stable user identifier from your auth layer (NOT IP).
